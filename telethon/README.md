# Telegram Client на Python с Telethon

Telegram-скрипт для сбора и мониторинга сообщений с использованием библиотеки Telethon. Проект включает локальную базу данных SQLite для хранения сообщений и асинхронную обработку новых сообщений в реальном времени.

## Возможности

- Подключение к Telegram через Telethon API
- Получение списка всех доступных диалогов (чатов)
- Сбор последних N сообщений из выбранного чата
- Автоматическое сохранение сообщений в локальную базу данных SQLite
- Проверка дубликатов при сохранении
- Асинхронный обработчик новых сообщений в реальном времени
- Логирование всех действий в файл и консоль
- Обработка ошибок и автоматические переподключения
- Поддержка всех типов чатов (личные, группы, каналы)

## Требования

- Python 3.7 или выше
- Аккаунт Telegram
- API credentials (api_id и api_hash) от Telegram

## Установка

1. **Клонируйте репозиторий или скачайте файлы проекта**

2. **Создайте виртуальное окружение:**

   Для Windows:
   ```bash
   python -m venv venv
   ```

   Для Linux/Mac:
   ```bash
   python3 -m venv venv
   ```

3. **Активируйте виртуальное окружение:**

   Для Windows (PowerShell):
   ```bash
   .\venv\Scripts\Activate.ps1
   ```

   Для Windows (Command Prompt):
   ```bash
   venv\Scripts\activate.bat
   ```

   Для Linux/Mac:
   ```bash
   source venv/bin/activate
   ```

   После активации в начале командной строки появится префикс `(venv)`.

4. **Установите зависимости:**
   ```bash
   pip install -r requirements.txt
   ```

   Примечание: Убедитесь, что виртуальное окружение активировано перед установкой зависимостей.

## Настройка

### Получение API credentials

1. Перейдите на [https://my.telegram.org/apps](https://my.telegram.org/apps)
2. Войдите в свой аккаунт Telegram
3. Создайте новое приложение (если еще не создано)
4. Скопируйте `api_id` и `api_hash`

### Настройка config.py

Откройте файл `config.py` и укажите ваши данные:

```python
API_ID = 12345678  # Ваш api_id
API_HASH = "your_api_hash_here"  # Ваш api_hash
SESSION_NAME = "telegram_session"  # Имя файла сессии (можно оставить по умолчанию)
```

## Использование

### Запуск программы

```bash
python main.py
```

### Первый запуск

При первом запуске программа запросит:
1. **Номер телефона** — введите номер в международном формате (например, +79991234567)
2. **Код подтверждения** — код, который придет в Telegram
3. **Пароль двухфакторной аутентификации** (если включена) — введите пароль

После успешной авторизации будет создан файл сессии (`telegram_session.session`), и при следующих запусках авторизация не потребуется.

### Что делает программа

1. **Подключается к Telegram** и авторизуется
2. **Получает список доступных диалогов** и выводит их в консоль
3. **Собирает последние 100 сообщений** из первого чата (можно изменить в коде)
4. **Сохраняет сообщения в базу данных** SQLite
5. **Запускает live-слушателя** новых сообщений в реальном времени

### Live-мониторинг

После запуска live-слушателя программа будет:
- Отслеживать все новые сообщения во всех чатах
- Выводить их в консоль в формате: `[CHAT TITLE] sender: text`
- Автоматически сохранять в базу данных

Для остановки нажмите `Ctrl+C`.

### Деактивация виртуального окружения

После завершения работы с проектом можно деактивировать виртуальное окружение:

```bash
deactivate
```

## Структура проекта

```
telethon/
│
├── main.py              # Основной модуль с логикой Telegram клиента
├── db.py                # Модуль для работы с SQLite базой данных
├── config.py            # Конфигурационный файл с настройками
├── requirements.txt     # Зависимости проекта
├── README.md           # Документация проекта
│
├── telegram_session.session  # Файл сессии (создается автоматически)
├── telegram_messages.db      # База данных SQLite (создается автоматически)
└── telegram_client.log        # Файл логов (создается автоматически)
```

## База данных

### Структура таблицы `messages`

| Поле     | Тип        | Описание                    |
|----------|------------|-----------------------------|
| id       | INTEGER    | ID сообщения в Telegram     |
| chat_id  | INTEGER    | ID чата                     |
| sender   | TEXT       | Имя отправителя             |
| text     | TEXT       | Текст сообщения             |
| date     | TIMESTAMP  | Дата и время сообщения      |

### Особенности

- Автоматическая проверка дубликатов при вставке
- Индексы для быстрого поиска по `chat_id` и `date`
- Уникальное ограничение на пару `(id, chat_id)`

## Примеры использования

### Получение списка чатов

```python
dialogs = await bot.get_dialogs(limit=20)
bot.print_dialogs(dialogs)
```

### Сбор сообщений из чата

```python
messages = await bot.get_chat_messages(chat_id=123456789, limit=100)
await bot.save_messages_to_db(messages, "Название чата")
```

### Запуск live-слушателя

```python
await bot.start_listening()
```

## Логирование

Программа ведет логи в двух местах:
- **Консоль** — основные события и новые сообщения
- **Файл `telegram_client.log`** — подробные логи всех действий

Уровни логирования:
- `INFO` — основные события
- `DEBUG` — детальная информация
- `ERROR` — ошибки

## Важные замечания

1. **Безопасность**: Не публикуйте файл `telegram_session.session` и `config.py` с реальными данными
2. **Лимиты API**: Telegram имеет ограничения на количество запросов. При превышении программа автоматически ждет
3. **База данных**: Файл `telegram_messages.db` будет расти со временем. При необходимости можно очистить старые записи
4. **Права доступа**: Убедитесь, что у программы есть права на чтение/запись файлов в директории проекта

## Решение проблем

### Ошибка авторизации
- Проверьте правильность `api_id` и `api_hash` в `config.py`
- Убедитесь, что номер телефона введен в международном формате

### Ошибка подключения
- Проверьте интернет-соединение
- Убедитесь, что Telegram доступен в вашей стране/сети

### Ошибки базы данных
- Убедитесь, что у программы есть права на запись в директорию проекта
- Проверьте, что файл `telegram_messages.db` не заблокирован другой программой

## Дополнительная информация

- [Документация Telethon](https://docs.telethon.dev/)
- [Telegram API](https://core.telegram.org/api)

## Лицензия

Этот проект создан в образовательных целях.

---

**Примечание**: Используйте этот скрипт ответственно и в соответствии с правилами использования Telegram API.

